<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>HSK2 –ú–∞—Ç—á–∏–Ω–≥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden; /* —É–±–∏—Ä–∞–µ–º —Å–∫—Ä–æ–ª–ª—ã */
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f3f4f6;
    }

    #game {
      width: 100%;
      height: 100%;
      max-width: 800px;
      max-height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 1rem;
      box-sizing: border-box;
    }

    .fade-out {
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .fade-in {
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    .selected {
      border: 1px solid #3b82f6;
      background-color: #bfdbfe;
    }

    button {
      touch-action: manipulation; /* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –æ—Ç–∫–ª–∏–∫–∞ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
    }

    /* üì± –ê–¥–∞–ø—Ç–∏–≤ –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */
    @media (max-width: 768px) {
      #game-board {
        grid-template-columns: 1fr; /* –∫–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É */
        gap: 1rem;
      }

      #rus, #hanzi {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      button {
        font-size: 1.25rem;
        padding: 1rem;
      }

      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="game" class="bg-white rounded-none shadow-lg">
    <h1 class="text-2xl font-bold mb-2 text-center">HSK2: –°–æ–µ–¥–∏–Ω–∏ –ø–µ—Ä–µ–≤–æ–¥ –∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ</h1>

    <div class="mb-2 text-center">
      <label class="inline-flex items-center gap-2 text-sm font-medium">
        <input type="checkbox" id="toggle-pinyin" class="accent-blue-500" checked>
        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–∏–Ω—å–∏–Ω—å
      </label>
    </div>

    <div id="game-board" class="grid grid-cols-2 gap-4 flex-grow overflow-hidden">
      <div id="rus" class="flex flex-col gap-2 overflow-auto"></div>
      <div id="hanzi" class="flex flex-col gap-2 overflow-auto"></div>
    </div>

    <div id="result" class="mt-4 text-center text-xl font-semibold hidden"></div>
    <div id="controls" class="mt-2 text-center hidden">
      <button id="restart" class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600">–ò–≥—Ä–∞—Ç—å –µ—â—ë</button>
    </div>
  </div>

  <script>
    let words = [];
    let remainingWords = [];
    let currentWords = [];
    let startTime;
    let selectedRu = null;
    let audioMap = new Map();

    const toggle = document.getElementById("toggle-pinyin");

    // === –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ ===
    const saved = localStorage.getItem("showPinyin");
    if (saved !== null) {
      toggle.checked = saved === "true";
    }

    // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö (–±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏)
    toggle.addEventListener("change", () => {
      const showPinyin = toggle.checked;
      localStorage.setItem("showPinyin", showPinyin);

      // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ —É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
      const hanziButtons = document.querySelectorAll("#hanzi button");
      hanziButtons.forEach((btn, i) => {
        const w = currentWords[i];
        if (!w) return;
        btn.textContent = showPinyin ? `${w.hanzi} (${w.pinyin})` : w.hanzi;
      });
    });

    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function renderPair() {
      const rusCol = document.getElementById("rus");
      const hanziCol = document.getElementById("hanzi");
      const showPinyin = toggle.checked;

      rusCol.innerHTML = "";
      hanziCol.innerHTML = "";
      audioMap.clear();

      const ruButtons = currentWords.map(w => {
        const btn = document.createElement("button");
        btn.textContent = w.ru;
        btn.className = "px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300";
        btn.onclick = () => selectRu(w, btn);
        return btn;
      });

      const hanziButtons = currentWords.map(w => {
        const btn = document.createElement("button");
        btn.textContent = showPinyin ? `${w.hanzi} (${w.pinyin})` : w.hanzi;
        btn.className = "px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300";
        btn.onclick = () => selectHanzi(w, btn);

        if (w.audio) {
          const audio = new Audio(w.audio);
          audio.load();
          audioMap.set(w.hanzi, audio);
        }

        return btn;
      });

      shuffle(ruButtons).forEach(btn => rusCol.appendChild(btn));
      shuffle(hanziButtons).forEach(btn => hanziCol.appendChild(btn));
    }

    function selectRu(word, btn) {
      if (selectedRu && selectedRu.btn) {
        selectedRu.btn.classList.remove("selected");
      }
      selectedRu = { word, btn };
      btn.classList.add("selected");
    }

    function selectHanzi(word, btn) {
      if (!selectedRu) return;

      if (selectedRu.word.hanzi === word.hanzi) {
        const audio = audioMap.get(word.hanzi);
        if (audio) audio.play();

        selectedRu.btn.disabled = true;
        btn.disabled = true;
        selectedRu.btn.classList.add("opacity-50");
        selectedRu.btn.classList.remove("selected");
        btn.classList.remove("selected");
        btn.classList.add("opacity-50");

        currentWords = currentWords.filter(w => w.hanzi !== word.hanzi);

        if (currentWords.length === 0) {
          if (remainingWords.length === 0) {
            finishGame();
          } else {
            loadNextRound();
          }
        }
      } else {
        selectedRu.btn.classList.remove("selected");
      }

      selectedRu = null;
    }

    function loadNextRound() {
      const nextCount = Math.min(5, remainingWords.length);
      currentWords = shuffle(remainingWords).slice(0, nextCount);
      remainingWords = remainingWords.filter(w => !currentWords.includes(w));
      renderPair();
    }

    function finishGame() {
      const endTime = Date.now();
      const timeTaken = ((endTime - startTime) / 1000).toFixed(1);
      document.getElementById("game-board").classList.add("hidden");
      document.getElementById("result").classList.remove("hidden");
      document.getElementById("controls").classList.remove("hidden");
      document.getElementById("result").textContent = `–ì–æ—Ç–æ–≤–æ! –í—ã —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å –∑–∞ ${timeTaken} —Å–µ–∫—É–Ω–¥.`;
    }

    function startGame() {
      remainingWords = shuffle([...words]);
      startTime = Date.now();
      document.getElementById("game-board").classList.remove("hidden");
      document.getElementById("result").classList.add("hidden");
      document.getElementById("controls").classList.add("hidden");
      loadNextRound();
    }

    document.getElementById("restart").onclick = startGame;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –≤–Ω–µ—à–Ω–µ–≥–æ URL
    fetch('https://notrobot1.github.io/chinese/words/hsk2/words.json')
      .then(response => {
        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        words = data;
        startGame();
      })
      .catch(error => {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:', error);
        document.getElementById("game").innerHTML = `<p class="text-red-500 text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>`;
      });
  </script>
</body>
</html>
