<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>HSK2 Матчинг</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden; /* убираем скроллы */
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f3f4f6;
    }

    #game {
      width: 100%;
      height: 100%;
      max-width: 800px;
      max-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 1rem;
      box-sizing: border-box;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .selected {
      border: 1px solid #3b82f6;
      background-color: #bfdbfe;
    }

    button {
      touch-action: manipulation; /* убирает задержку на мобилках */
    }

    /* Адаптив под мобильные устройства */
    @media (max-width: 768px) {
      #game-board {
        grid-template-columns: 1fr; /* колонки в одну колонку */
        gap: 1rem;
      }

      #rus, #hanzi {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      button {
        font-size: 1.25rem;
        padding: 1rem;
      }

      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="game">
    <h1 class="text-2xl font-bold mb-2 text-center">HSK2: Соедини перевод и иероглиф</h1>

    <!-- Галочка "Показывать пиньинь" -->
    <div class="mb-2 text-center">
      <label class="inline-flex items-center gap-2 text-sm font-medium">
        <input type="checkbox" id="toggle-pinyin" class="accent-blue-500" checked>
        Показывать пиньинь
      </label>
    </div>

    <div id="game-board" class="grid grid-cols-2 gap-4 flex-grow overflow-hidden">
      <div id="rus" class="flex flex-col gap-2 overflow-auto"></div>
      <div id="hanzi" class="flex flex-col gap-2 overflow-auto"></div>
    </div>

    <div id="result" class="mt-4 text-center text-xl font-semibold hidden"></div>
    <div id="controls" class="mt-2 text-center hidden">
      <button id="restart" class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600">Играть ещё</button>
    </div>

    <div id="home-button" class="mt-4 text-center">
      <a href="/" class="inline-block px-4 py-2 bg-gray-300 rounded-xl hover:bg-gray-400 text-gray-800 font-medium">
        Главная
      </a>
    </div>
  </div>

  <script>
    let words = [];
    let remainingWords = [];
    let currentWords = [];
    let startTime;
    let selectedRu = null;
    let audioMap = new Map();

    const toggle = document.getElementById("toggle-pinyin");
    const saved = localStorage.getItem("showPinyin");
    if (saved !== null) toggle.checked = saved === "true";

    toggle.addEventListener("change", () => {
      localStorage.setItem("showPinyin", toggle.checked);
      updatePinyinVisibility();
    });

    function updatePinyinVisibility() {
      const showPinyin = toggle.checked;
      document.querySelectorAll("#hanzi button").forEach(btn => {
        const hanzi = btn.dataset.hanzi;
        const pinyin = btn.dataset.pinyin;
        btn.textContent = showPinyin ? `${hanzi} (${pinyin})` : hanzi;
      });
    }

    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function renderPair() {
      const rusCol = document.getElementById("rus");
      const hanziCol = document.getElementById("hanzi");
      const showPinyin = toggle.checked;

      rusCol.innerHTML = "";
      hanziCol.innerHTML = "";
      audioMap.clear();

      const ruButtons = currentWords.map(w => {
        const btn = document.createElement("button");
        btn.textContent = w.ru;
        btn.className = "px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300";
        btn.onclick = () => selectRu(w, btn);
        return btn;
      });

      const hanziButtons = currentWords.map(w => {
        const btn = document.createElement("button");
        btn.textContent = showPinyin ? `${w.hanzi} (${w.pinyin})` : w.hanzi;
        btn.dataset.hanzi = w.hanzi;
        btn.dataset.pinyin = w.pinyin;
        btn.className = "px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300";
        btn.onclick = () => selectHanzi(w, btn);

        if (w.audio) {
          const audio = new Audio(w.audio);
          audio.load();
          audioMap.set(w.hanzi, audio);
        }
        return btn;
      });

      shuffle(ruButtons).forEach(btn => rusCol.appendChild(btn));
      shuffle(hanziButtons).forEach(btn => hanziCol.appendChild(btn));
    }

    function selectRu(word, btn) {
      if (selectedRu && selectedRu.btn) selectedRu.btn.classList.remove("selected");
      selectedRu = { word, btn };
      btn.classList.add("selected");
    }

    function selectHanzi(word, btn) {
      if (!selectedRu) return;

      if (selectedRu.word.hanzi === word.hanzi) {
        const audio = audioMap.get(word.hanzi);
        if (audio) audio.play();

        selectedRu.btn.disabled = true;
        btn.disabled = true;
        selectedRu.btn.classList.add("opacity-50");
        selectedRu.btn.classList.remove("selected");
        btn.classList.remove("selected");
        btn.classList.add("opacity-50");

        currentWords = currentWords.filter(w => w.hanzi !== word.hanzi);

        if (currentWords.length === 0) {
          if (remainingWords.length === 0) {
            finishGame();
          } else {
            loadNextRound();
          }
        }
      } else {
        selectedRu.btn.classList.remove("selected");
      }

      selectedRu = null;
    }

    function loadNextRound() {
      const nextCount = Math.min(5, remainingWords.length);
      currentWords = shuffle(remainingWords).slice(0, nextCount);
      remainingWords = remainingWords.filter(w => !currentWords.includes(w));
      renderPair();
    }

    function finishGame() {
      const endTime = Date.now();
      const timeTaken = ((endTime - startTime) / 1000).toFixed(1);
      document.getElementById("game-board").classList.add("hidden");
      document.getElementById("result").classList.remove("hidden");
      document.getElementById("controls").classList.remove("hidden");
      document.getElementById("result").textContent = `Готово! Вы справились за ${timeTaken} секунд.`;
    }

    function startGame() {
      remainingWords = shuffle([...words]);
      startTime = Date.now();
      document.getElementById("game-board").classList.remove("hidden");
      document.getElementById("result").classList.add("hidden");
      document.getElementById("controls").classList.add("hidden");
      loadNextRound();
    }

    document.getElementById("restart").onclick = startGame;

    // Загрузка данных с внешнего URL
    fetch('https://notrobot1.github.io/chinese/words/hsk2/words.json')
      .then(response => {
        if (!response.ok) throw new Error(`Ошибка загрузки: ${response.status}`);
        return response.json();
      })
      .then(data => {
        words = data;
        startGame();
      })
      .catch(error => {
        console.error('Не удалось загрузить данные:', error);
        document.getElementById("game").innerHTML = `<p class="text-red-500 text-center">Ошибка загрузки слов. Попробуйте позже.</p>`;
      });
  </script>
</body>
</html>
