<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>HSK2 –ú–∞—Ç—á–∏–Ω–≥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f3f4f6;
    }

    #game {
      width: 100%;
      height: 100%;
      max-width: 800px;
      max-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 1rem;
      box-sizing: border-box;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .selected {
      border: 1px solid #3b82f6;
      background-color: #bfdbfe;
    }

    button {
      touch-action: manipulation;
    }

    @media (max-width: 768px) {
      #game-board {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      #rus, #hanzi {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      button {
        font-size: 1.25rem;
        padding: 1rem;
      }

      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="game">
    <h1 class="text-2xl font-bold mb-2 text-center">HSK2: –°–æ–µ–¥–∏–Ω–∏ –ø–µ—Ä–µ–≤–æ–¥ –∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ</h1>

    <div class="mb-2 text-center">
      <label class="inline-flex items-center gap-2 text-sm font-medium">
        <input type="checkbox" id="toggle-pinyin" class="accent-blue-500" checked>
        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–∏–Ω—å–∏–Ω—å
      </label>
    </div>

    <div id="game-board" class="grid grid-cols-2 gap-4 flex-grow overflow-hidden">
      <div id="rus" class="flex flex-col gap-2 overflow-auto"></div>
      <div id="hanzi" class="flex flex-col gap-2 overflow-auto"></div>
    </div>

    <div id="result" class="mt-4 text-center text-xl font-semibold hidden"></div>
    <div id="controls" class="mt-2 text-center hidden">
      <button id="restart" class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600">
        –ò–≥—Ä–∞—Ç—å –µ—â—ë
      </button>
    </div>

    <div id="home-button" class="mt-4 text-center">
      <a href="/chinese" class="inline-block px-4 py-2 bg-gray-300 rounded-xl hover:bg-gray-400 text-gray-800 font-medium">
        –ì–ª–∞–≤–Ω–∞—è
      </a>
    </div>
  </div>

  <script>
    let words = [];
    let remainingWords = [];
    let currentWords = [];
    let startTime;
    let selectedRu = null;
    let audioMap = new Map();

    /* ================== –ë–ê–õ–õ–´ ================== */

    const SCORE_KEY = "wordScores";

    function loadScores() {
      return JSON.parse(localStorage.getItem(SCORE_KEY) || "{}");
    }

    function saveScores(scores) {
      localStorage.setItem(SCORE_KEY, JSON.stringify(scores));
    }

    let wordScores = loadScores();

    function addScore(word, delta) {
      if (!wordScores[word.hanzi]) {
        wordScores[word.hanzi] = 0;
      }
      wordScores[word.hanzi] += delta;
      saveScores(wordScores);
    }

    /* =========================================== */

    const toggle = document.getElementById("toggle-pinyin");
    const saved = localStorage.getItem("showPinyin");
    if (saved !== null) toggle.checked = saved === "true";

    toggle.addEventListener("change", () => {
      localStorage.setItem("showPinyin", toggle.checked);
      updatePinyinVisibility();
    });

    function updatePinyinVisibility() {
      const showPinyin = toggle.checked;
      document.querySelectorAll("#hanzi button").forEach(btn => {
        btn.textContent = showPinyin
          ? `${btn.dataset.hanzi} (${btn.dataset.pinyin})`
          : btn.dataset.hanzi;
      });
    }

    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function renderPair() {
      const rusCol = document.getElementById("rus");
      const hanziCol = document.getElementById("hanzi");
      const showPinyin = toggle.checked;

      rusCol.innerHTML = "";
      hanziCol.innerHTML = "";
      audioMap.clear();

      const ruButtons = currentWords.map(w => {
        const btn = document.createElement("button");
        btn.textContent = w.ru;
        btn.className = "px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300";
        btn.onclick = () => selectRu(w, btn);
        return btn;
      });

      const hanziButtons = currentWords.map(w => {
        const btn = document.createElement("button");
        btn.textContent = showPinyin ? `${w.hanzi} (${w.pinyin})` : w.hanzi;
        btn.dataset.hanzi = w.hanzi;
        btn.dataset.pinyin = w.pinyin;
        btn.className = "px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300";
        btn.onclick = () => selectHanzi(w, btn);

        if (w.audio) {
          const audio = new Audio(w.audio);
          audio.load();
          audioMap.set(w.hanzi, audio);
        }
        return btn;
      });

      shuffle(ruButtons).forEach(b => rusCol.appendChild(b));
      shuffle(hanziButtons).forEach(b => hanziCol.appendChild(b));
    }

    function selectRu(word, btn) {
      if (selectedRu) selectedRu.btn.classList.remove("selected");
      selectedRu = { word, btn };
      btn.classList.add("selected");
    }

    function selectHanzi(word, btn) {
      if (!selectedRu) return;

      const remainingCount = currentWords.length;

      if (selectedRu.word.hanzi === word.hanzi) {
        // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        const points = Math.max(0, (remainingCount - 1) * 2);
        addScore(word, points);

        const audio = audioMap.get(word.hanzi);
        if (audio) audio.play();

        selectedRu.btn.disabled = true;
        btn.disabled = true;
        selectedRu.btn.classList.add("opacity-50");
        btn.classList.add("opacity-50");
        selectedRu.btn.classList.remove("selected");

        currentWords = currentWords.filter(w => w.hanzi !== word.hanzi);

        if (currentWords.length === 0) {
          remainingWords.length === 0 ? finishGame() : loadNextRound();
        }
      } else {
        // ‚ùå –æ—à–∏–±–∫–∞
        addScore(selectedRu.word, -10);
        addScore(word, -10);
        selectedRu.btn.classList.remove("selected");
      }

      selectedRu = null;
    }

    function loadNextRound() {
      const count = Math.min(5, remainingWords.length);
      currentWords = shuffle(remainingWords).slice(0, count);
      remainingWords = remainingWords.filter(w => !currentWords.includes(w));
      renderPair();
    }

    function finishGame() {
      const time = ((Date.now() - startTime) / 1000).toFixed(1);
      document.getElementById("game-board").classList.add("hidden");
      document.getElementById("result").classList.remove("hidden");
      document.getElementById("controls").classList.remove("hidden");
      document.getElementById("result").textContent =
        `–ì–æ—Ç–æ–≤–æ! –í—ã —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å –∑–∞ ${time} —Å–µ–∫—É–Ω–¥.`;
    }

    function startGame() {
      remainingWords = shuffle([...words]);
      startTime = Date.now();
      document.getElementById("game-board").classList.remove("hidden");
      document.getElementById("result").classList.add("hidden");
      document.getElementById("controls").classList.add("hidden");
      loadNextRound();
    }

    document.getElementById("restart").onclick = startGame;

    fetch("https://notrobot1.github.io/chinese/words/hsk2/words.json")
      .then(r => r.json())
      .then(data => {
        words = data;
        startGame();
      })
      .catch(() => {
        document.getElementById("game").innerHTML =
          "<p class='text-red-500 text-center'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤</p>";
      });
  </script>

    <!-- üìä Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NCV9GEMVYB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-NCV9GEMVYB');
    </script>
</body>
</html>
