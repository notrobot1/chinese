<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>–°–æ–±–µ—Ä–∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ –ø–æ —à—Ç—Ä–∏—Ö–∞–º</title>
<script src="https://unpkg.com/hanzi-writer/dist/hanzi-writer.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
  }
  #word-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }
  .writer {
    border: 1px solid #ccc;
    flex: 1 1 80px;
    max-width: 220px;
    height: auto;
  }
  @media (max-width: 768px) {
    .writer {
      flex: 1 1 40%;
    }
  }
  #pinyin {
    font-size: 20px;
    margin-top: 10px;
  }
  #translation {
    font-size: 18px;
    color: #555;
    margin-top: 5px;
  }
  #controls {
    margin-top: 15px;
  }
  button {
    font-size: 16px;
    padding: 6px 12px;
    cursor: pointer;
  }
  #progress {
    margin-top: 15px;
    font-size: 18px;
  }
</style>
</head>
<body>
<h2>–°–æ–±–µ—Ä–∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ –ø–æ —à—Ç—Ä–∏—Ö–∞–º</h2>

<div id="word-container"></div>
<div id="pinyin"></div>
<div id="translation"></div>
<div id="controls">
  <button id="play-audio">‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
</div>
<div id="progress"></div>

<script>
async function fetchWords() {
  const urls = [
    "https://notrobot1.github.io/chinese/words/hsk1/words.json",
    "https://notrobot1.github.io/chinese/words/hsk2/words.json"
  ];
  const results = await Promise.all(urls.map(u => fetch(u).then(r => r.json())));
  return results.flat();
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

let words = [];
let totalCount = 0;
let currentIndex = 0;

async function init() {
  const savedState = localStorage.getItem('hanziProgress');
  if (savedState) {
    // –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º
    const state = JSON.parse(savedState);
    words = state.words;
    currentIndex = state.currentIndex;
  } else {
    // –∏–Ω–∞—á–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
    words = shuffle(await fetchWords());
    currentIndex = 0;
  }
  totalCount = words.length;
  showNextWord();
}

function saveProgress() {
  localStorage.setItem('hanziProgress', JSON.stringify({
    words: words,
    currentIndex: currentIndex
  }));
}

function showNextWord() {
  if (currentIndex >= totalCount) {
    document.getElementById("word-container").innerHTML =
      "<h3>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—Å–µ —Å–ª–æ–≤–∞ –ø—Ä–æ–π–¥–µ–Ω—ã üéâ</h3>";
    document.getElementById("pinyin").textContent = "";
    document.getElementById("translation").textContent = "";
    document.getElementById("controls").style.display = "none";
    document.getElementById("progress").textContent = `–í—Å–µ–≥–æ —Å–ª–æ–≤: ${totalCount}`;
    localStorage.removeItem('hanziProgress');
    return;
  }

  const word = words[currentIndex];
  const container = document.getElementById("word-container");
  container.innerHTML = "";

  const chars = word.hanzi.split("");
  let remaining = chars.length;

  chars.forEach((ch, idx) => {
    const div = document.createElement("div");
    div.className = "writer";
    div.id = "writer_" + idx;
    container.appendChild(div);

    const w = HanziWriter.create(div.id, ch, {
      width: div.offsetWidth,
      height: div.offsetWidth,
      showOutline: true,
      showCharacter: false,
      padding: 5,
      showHintAfterMisses: 1
    });

    w._done = false;

    w.quiz({
      onComplete: () => {
        if (w._done) return;
        w._done = true;
        remaining--;

        div.style.border = "2px solid #8f8";

        if (remaining === 0) {
          currentIndex++;
          saveProgress(); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          document.getElementById("progress").textContent =
            `–ü—Ä–æ–π–¥–µ–Ω–æ: ${currentIndex}/${totalCount}`;
          setTimeout(showNextWord, 300);
        }
      }
    });
  });

  // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é —á–∞—Å—Ç—å
  document.getElementById("pinyin").textContent = `${word.hanzi} ‚Äî ${word.pinyin}`;
  document.getElementById("translation").textContent = word.ru || "";
  document.getElementById("progress").textContent =
    `–ü—Ä–æ–π–¥–µ–Ω–æ: ${currentIndex}/${totalCount}`;

  // –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
  const audio = new Audio(word.audio);
  document.getElementById("play-audio").onclick = () => audio.play();
}

// –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –±–ª–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
function updateWriterSizes() {
  document.querySelectorAll('.writer').forEach(div => {
    const width = div.offsetWidth;
    div.style.height = width + 'px';
  });
}

window.addEventListener('resize', updateWriterSizes);
window.addEventListener('load', updateWriterSizes);

init();
</script>
</body>
</html>
