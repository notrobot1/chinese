<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>–°–æ–±–µ—Ä–∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ –ø–æ —à—Ç—Ä–∏—Ö–∞–º</title>
<script src="https://unpkg.com/hanzi-writer/dist/hanzi-writer.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
  }
  #word-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }
  .writer {
    border: 1px solid #ccc;
    flex: 1 1 80px;
    max-width: 220px;
    height: auto;
  }
  @media (max-width: 768px) {
    .writer {
      flex: 1 1 40%;
    }
  }
  #pinyin {
    font-size: 20px;
    margin-top: 10px;
  }
  #translation {
    font-size: 18px;
    color: #555;
    margin-top: 5px;
  }
  #controls {
    margin-top: 15px;
  }
  button {
    font-size: 16px;
    padding: 6px 12px;
    cursor: pointer;
  }
  #progress {
    margin-top: 15px;
    font-size: 18px;
  }

  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
  .modal {
    display: none;
    position: fixed;
    z-index: 10;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 300px;
    text-align: left;
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 22px;
    font-weight: bold;
    cursor: pointer;
  }
  .close:hover {
    color: black;
  }
  label {
    display: block;
    margin: 10px 0;
  }
</style>
</head>
<body>
<h2>–°–æ–±–µ—Ä–∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ –ø–æ —à—Ç—Ä–∏—Ö–∞–º</h2>
<h1 id="title"></h1>

<div id="word-container"></div>
<div id="pinyin"></div>
<div id="translation"></div>
<div id="controls">
  <button id="play-audio">‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
  <button id="settings-btn">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>
<div id="progress"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
<div id="settings-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
    <label>
      <input type="checkbox" id="show-hanzi">
      –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–µ—Ä–æ–≥–ª–∏—Ñ —Ü–µ–ª–∏–∫–æ–º
    </label>
    <label>
      <input type="checkbox" id="hard-mode">
      –°–ª–æ–∂–Ω—ã–π —Ä–µ–∂–∏–º (–ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
    </label>
    <button id="save-settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<script>
async function fetchWords() {
  const urls = [
    "https://notrobot1.github.io/chinese/words/hsk1/words.json",
    "https://notrobot1.github.io/chinese/words/hsk2/words.json"
  ];
  const results = await Promise.all(urls.map(u => fetch(u).then(r => r.json())));
  return results.flat();
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

let words = [];
let totalCount = 0;
let currentIndex = 0;
let settings = { showHanzi: true, hardMode: false };

async function init() {
  // –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  const savedSettings = localStorage.getItem('hanziSettings');
  if (savedSettings) {
    settings = JSON.parse(savedSettings);
  }

  // –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —á–µ–∫–±–æ–∫—Å–∞—Ö
  document.getElementById('show-hanzi').checked = settings.showHanzi;
  document.getElementById('hard-mode').checked = settings.hardMode;

  // –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
  const savedState = localStorage.getItem('hanziProgress');
  if (savedState) {
    const state = JSON.parse(savedState);
    words = state.words;
    currentIndex = state.currentIndex;
  } else {
    words = shuffle(await fetchWords());
    currentIndex = 0;
  }
  totalCount = words.length;
  showNextWord();
}

function saveProgress() {
  localStorage.setItem('hanziProgress', JSON.stringify({
    words: words,
    currentIndex: currentIndex
  }));
}

function saveSettings() {
  settings.showHanzi = document.getElementById('show-hanzi').checked;
  settings.hardMode = document.getElementById('hard-mode').checked;
  localStorage.setItem('hanziSettings', JSON.stringify(settings));
}

function showNextWord() {
  if (currentIndex >= totalCount) {
    document.getElementById("word-container").innerHTML =
      "<h3>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—Å–µ —Å–ª–æ–≤–∞ –ø—Ä–æ–π–¥–µ–Ω—ã üéâ</h3>";
    document.getElementById("pinyin").textContent = "";
    document.getElementById("title").textContent = "";
    document.getElementById("translation").textContent = "";
    document.getElementById("controls").style.display = "none";
    document.getElementById("progress").textContent = `–í—Å–µ–≥–æ —Å–ª–æ–≤: ${totalCount}`;
    localStorage.removeItem('hanziProgress');
    return;
  }

  const word = words[currentIndex];
  const container = document.getElementById("word-container");
  container.innerHTML = "";

  const chars = word.hanzi.split("");
  let remaining = chars.length;
  let errorsOccurred = false; // –¥–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞

  chars.forEach((ch, idx) => {
    const div = document.createElement("div");
    div.className = "writer";
    div.id = "writer_" + idx;
    container.appendChild(div);

    const w = HanziWriter.create(div.id, ch, {
      width: div.offsetWidth,
      height: div.offsetWidth,
      showOutline: settings.showHanzi,
      showCharacter: settings.showHanzi,
      padding: 5,
      showHintAfterMisses: 1
    });

    w._done = false;

    w.quiz({
      onMistake: () => {
        errorsOccurred = true;
      },
      onComplete: () => {
        if (w._done) return;
        w._done = true;
        remaining--;

        div.style.border = "2px solid #8f8";

        if (remaining === 0) {
          // —Å–ª–æ–∂–Ω—ã–π —Ä–µ–∂–∏–º: –µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏, –ø–æ–≤—Ç–æ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ
          if (settings.hardMode && errorsOccurred) {
            setTimeout(showNextWord, 300); // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ç–æ –∂–µ —Å–ª–æ–≤–æ —Å–Ω–æ–≤–∞
          } else {
            currentIndex++;
            saveProgress();
            document.getElementById("progress").textContent =
              `–ü—Ä–æ–π–¥–µ–Ω–æ: ${currentIndex}/${totalCount}`;
            setTimeout(showNextWord, 300);
          }
        }
      }
    });
  });

  document.getElementById("pinyin").textContent = `${word.hanzi} ‚Äî ${word.pinyin}`;
  document.getElementById("title").textContent = `${word.hanzi}`;
  document.getElementById("translation").textContent = word.ru || "";
  document.getElementById("progress").textContent =
    `–ü—Ä–æ–π–¥–µ–Ω–æ: ${currentIndex}/${totalCount}`;

  const audio = new Audio(word.audio);
  document.getElementById("play-audio").onclick = () => audio.play();
}

// –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –±–ª–æ–∫–∏
function updateWriterSizes() {
  document.querySelectorAll('.writer').forEach(div => {
    const width = div.offsetWidth;
    div.style.height = width + 'px';
  });
}

window.addEventListener('resize', updateWriterSizes);
window.addEventListener('load', updateWriterSizes);

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
const modal = document.getElementById("settings-modal");
const btn = document.getElementById("settings-btn");
const span = document.querySelector(".close");

btn.onclick = () => modal.style.display = "block";
span.onclick = () => modal.style.display = "none";
window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };
document.getElementById("save-settings").onclick = () => {
  saveSettings();
  modal.style.display = "none";
  // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
  showNextWord();
};

init();
</script>
</body>
</html>
