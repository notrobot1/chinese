<script>
async function fetchWords() {
  const urls = [
    "https://notrobot1.github.io/chinese/words/hsk1/words.json",
    "https://notrobot1.github.io/chinese/words/hsk2/words.json"
  ];
  const results = await Promise.all(urls.map(u => fetch(u).then(r => r.json())));
  return results.flat();
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

let words = [];
let totalCount = 0;
let currentIndex = 0; // —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å —Å–ª–æ–≤–∞

async function init() {
  words = shuffle(await fetchWords());
  totalCount = words.length;

  // –ø—Ä–æ–≤–µ—Ä—è–µ–º localStorage
  const savedIndex = localStorage.getItem('currentWordIndex');
  if (savedIndex !== null && !isNaN(savedIndex)) {
    currentIndex = parseInt(savedIndex, 10);
  }

  showNextWord();
}

function showNextWord() {
  if (currentIndex >= totalCount) {
    document.getElementById("word-container").innerHTML =
      "<h3>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—Å–µ —Å–ª–æ–≤–∞ –ø—Ä–æ–π–¥–µ–Ω—ã üéâ</h3>";
    document.getElementById("pinyin").textContent = "";
    document.getElementById("translation").textContent = "";
    document.getElementById("controls").style.display = "none";
    document.getElementById("progress").textContent = `–í—Å–µ–≥–æ —Å–ª–æ–≤: ${totalCount}`;
    localStorage.removeItem('currentWordIndex');
    return;
  }

  const word = words[currentIndex];
  const container = document.getElementById("word-container");
  container.innerHTML = "";

  const chars = word.hanzi.split("");
  let remaining = chars.length;

  chars.forEach((ch, idx) => {
    const div = document.createElement("div");
    div.className = "writer";
    div.id = "writer_" + idx;
    container.appendChild(div);

    const w = HanziWriter.create(div.id, ch, {
      width: div.offsetWidth,
      height: div.offsetWidth,
      showOutline: true,
      showCharacter: false,
      padding: 5,
      showHintAfterMisses: 1
    });

    w._done = false;

    w.quiz({
      onComplete: () => {
        if (w._done) return;
        w._done = true;
        remaining--;

        div.style.border = "2px solid #8f8";

        if (remaining === 0) {
          currentIndex++;
          localStorage.setItem('currentWordIndex', currentIndex); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          document.getElementById("progress").textContent =
            `–ü—Ä–æ–π–¥–µ–Ω–æ: ${currentIndex}/${totalCount}`;
          setTimeout(showNextWord, 300);
        }
      }
    });
  });

  // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é —á–∞—Å—Ç—å
  document.getElementById("pinyin").textContent = `${word.hanzi} ‚Äî ${word.pinyin}`;
  document.getElementById("translation").textContent = word.ru || "";
  document.getElementById("progress").textContent =
    `–ü—Ä–æ–π–¥–µ–Ω–æ: ${currentIndex}/${totalCount}`;

  // –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
  const audio = new Audio(word.audio);
  document.getElementById("play-audio").onclick = () => audio.play();
}

init();
</script>
