<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>HSK2 –ú–∞—Ç—á–∏–Ω–≥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-out {
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .fade-in {
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    .selected {
      border: 0.5px solid #3b82f6; /* —Å–∏–Ω—è—è —Ä–∞–º–∫–∞ */
      background-color: #bfdbfe; /* —Å–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω */
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div id="game" class="w-full max-w-4xl bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">HSK1: –°–æ–µ–¥–∏–Ω–∏ –ø–µ—Ä–µ–≤–æ–¥ –∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ</h1>
    <div id="game-board" class="grid grid-cols-2 gap-4">
      <div id="rus" class="flex flex-col gap-2"></div>
      <div id="hanzi" class="flex flex-col gap-2"></div>
    </div>
    <div id="result" class="mt-6 text-center text-xl font-semibold hidden"></div>
    <div id="controls" class="mt-4 text-center hidden">
      <button id="restart" class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600">–ò–≥—Ä–∞—Ç—å –µ—â—ë</button>
    </div>
  </div>

<script>
  const WORDS_URL = "https://notrobot1.github.io/chinese/words/hsk2/words.json";

  let words = [];
  let remainingWords = [];
  let currentWords = [];

  let startTime;
  let selectedRu = null;
  let audioMap = new Map();

  function shuffle(arr) {
    return arr.sort(() => Math.random() - 0.5);
  }

  async function loadWords() {
    try {
      const res = await fetch(WORDS_URL);
      if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤");
      words = await res.json();
      startGame();
    } catch (e) {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞ üò¢");
      console.error(e);
    }
  }

  function renderPair() {
    const rusCol = document.getElementById("rus");
    const hanziCol = document.getElementById("hanzi");

    rusCol.innerHTML = "";
    hanziCol.innerHTML = "";
    audioMap.clear();

    const ruButtons = currentWords.map(w => {
      const btn = document.createElement("button");
      btn.innerHTML = "üîä";
      btn.className = "px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300 text-2xl";
      btn.onclick = () => selectRu(w, btn);

      if (w.audio) {
        const audio = new Audio(w.audio);
        audio.load();
        audioMap.set(w.hanzi, audio);
      }
      return btn;
    });

    const hanziButtons = currentWords.map(w => {
      const btn = document.createElement("button");
      btn.textContent = w.hanzi;
      btn.className = "px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300 text-xl";
      btn.onclick = () => selectHanzi(w, btn);
      return btn;
    });

    shuffle(ruButtons).forEach(b => rusCol.appendChild(b));
    shuffle(hanziButtons).forEach(b => hanziCol.appendChild(b));
  }

  function selectRu(word, btn) {
    if (selectedRu?.btn) {
      selectedRu.btn.classList.remove("selected");
    }

    selectedRu = { word, btn };
    btn.classList.add("selected");

    const audio = audioMap.get(word.hanzi);
    if (audio) {
      audio.currentTime = 0;
      audio.play();
    }
  }

  function selectHanzi(word, btn) {
    if (!selectedRu) return;

    if (selectedRu.word.hanzi === word.hanzi) {
      const audio = audioMap.get(word.hanzi);
      if (audio) audio.play();

      selectedRu.btn.disabled = true;
      btn.disabled = true;

      selectedRu.btn.classList.add("opacity-50");
      btn.classList.add("opacity-50");
      selectedRu.btn.classList.remove("selected");

      currentWords = currentWords.filter(w => w.hanzi !== word.hanzi);

      if (currentWords.length === 0) {
        remainingWords.length ? loadNextRound() : finishGame();
      }
    } else {
      selectedRu.btn.classList.remove("selected");
    }

    selectedRu = null;
  }

  function loadNextRound() {
    const count = Math.min(5, remainingWords.length);
    currentWords = shuffle(remainingWords).slice(0, count);
    remainingWords = remainingWords.filter(w => !currentWords.includes(w));
    renderPair();
  }

  function finishGame() {
    const timeTaken = ((Date.now() - startTime) / 1000).toFixed(1);
    document.getElementById("game-board").classList.add("hidden");
    document.getElementById("result").classList.remove("hidden");
    document.getElementById("controls").classList.remove("hidden");
    document.getElementById("result").textContent =
      `–ì–æ—Ç–æ–≤–æ! –í—ã —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å –∑–∞ ${timeTaken} —Å–µ–∫—É–Ω–¥.`;
  }

  function startGame() {
    remainingWords = shuffle([...words]);
    startTime = Date.now();
    document.getElementById("game-board").classList.remove("hidden");
    document.getElementById("result").classList.add("hidden");
    document.getElementById("controls").classList.add("hidden");
    loadNextRound();
  }

  document.getElementById("restart").onclick = startGame;

  // üöÄ —Å—Ç–∞—Ä—Ç—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ JSON
  loadWords();
</script>


  <!-- üìä Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NCV9GEMVYB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-NCV9GEMVYB');
  </script>
</body>
</html>
